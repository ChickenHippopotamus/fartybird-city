<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Farty Bird: City Nights</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

  body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #0a0a1a;
    font-family: 'Press Start 2P', cursive;
    touch-action: none;
    user-select: none;
    -webkit-user-select: none;
  }

  #game-container {
    position: relative;
    width: 100vw;
    height: 100vh;
    background-color: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  canvas {
    display: block;
    box-shadow: 0 0 30px rgba(0,0,0,0.8);
    image-rendering: pixelated;
  }

  #ui-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    z-index: 10;
  }

  .hidden { display: none !important; opacity: 0; transition: opacity 0.3s; }

  /* HUD */
  #score-display {
    position: absolute;
    top: 10%;
    font-size: 4rem;
    color: white;
    text-shadow: 4px 4px 0 #000;
    z-index: 20;
    pointer-events: none;
  }

  /* SCREENS */
  #start-screen, #game-over-screen {
    background: rgba(0, 0, 0, 0.9);
    padding: 25px;
    border: 4px solid #f4b41b;
    border-radius: 15px;
    color: white;
    pointer-events: auto;
    box-shadow: 0 10px 20px rgba(0,0,0,0.8);
    max-width: 90%;
    min-width: 320px;
    max-height: 90vh;
    overflow-y: auto;
  }

  h1 {
    font-size: 2.2rem;
    margin: 0 0 15px 0;
    color: #f4b41b;
    text-shadow: 4px 4px 0 #000, -2px -2px 0 #4a2c00;
    letter-spacing: -2px;
    line-height: 1.2;
  }

  p {
    font-size: 0.9rem;
    line-height: 1.6;
    margin-bottom: 20px;
    color: #ddd;
    text-shadow: 1px 1px 0 #000;
  }

  .footer-text {
    margin-top: 20px;
    font-size: 0.6rem;
    color: #888;
    opacity: 0.9;
    line-height: 1.6;
    border-top: 2px dashed #444;
    padding-top: 15px;
  }

  /* BUTTONS */
  .btn {
    background: #e06020;
    border: 4px solid #fff;
    color: white;
    padding: 15px 30px;
    font-family: 'Press Start 2P', cursive;
    font-size: 1rem;
    cursor: pointer;
    text-transform: uppercase;
    box-shadow: 0 6px 0 #8a3000;
    transition: transform 0.1s, background 0.2s;
    margin-top: 10px;
  }

  .btn:active {
    transform: translateY(6px);
    box-shadow: 0 0 0 #8a3000;
  }

  .btn:hover {
    background: #ff7b38;
  }

  /* CHARACTER SELECTOR */
  .character-selector {
    margin: 15px 0;
    background: rgba(255,255,255,0.05);
    padding: 10px;
    border-radius: 10px;
  }

  .character-selector label, .difficulty-selector label {
    font-size: 0.7rem;
    color: #ffcc00;
    display: block;
    margin-bottom: 8px;
    text-shadow: 2px 2px 0 #000;
  }

  .character-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    max-width: 280px;
    margin: 0 auto;
  }

  .char-btn {
    width: 50px;
    height: 50px;
    border: 2px solid #444;
    border-radius: 8px;
    background: #222;
    cursor: pointer;
    padding: 0;
    overflow: hidden;
    transition: all 0.2s;
  }

  .char-btn.selected {
    border-color: #f4b41b;
    box-shadow: 0 0 10px #f4b41b;
    background: #332200;
  }

  .char-preview { width: 100%; height: 100%; display: block; }

  /* DIFFICULTY */
  .difficulty-selector { margin: 15px 0; }
  .difficulty-btns { display: flex; gap: 8px; justify-content: center; }
  
  .diff-btn {
    padding: 8px 12px;
    border: 2px solid #555;
    border-radius: 6px;
    background: rgba(0,0,0,0.5);
    color: #888;
    font-family: 'Press Start 2P', cursive;
    font-size: 0.6rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .diff-btn.selected {
    border-color: #fff;
    color: #fff;
    transform: scale(1.05);
    box-shadow: 0 0 8px rgba(255,255,255,0.3);
  }
  
  .diff-btn[data-diff="easy"].selected { background: #27ae60; border-color: #2ecc71; }
  .diff-btn[data-diff="normal"].selected { background: #e67e22; border-color: #f39c12; }
  .diff-btn[data-diff="hard"].selected { background: #c0392b; border-color: #e74c3c; }

  /* LEADERBOARD & INPUT */
  #game-over-stats {
    background: rgba(0,0,0,0.3);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  
  #input-row {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin: 15px 0;
  }
  
  #player-name {
    width: 80px;
    background: #222;
    border: 2px solid #555;
    color: white;
    font-family: 'Press Start 2P', cursive;
    font-size: 0.8rem;
    padding: 5px;
    text-align: center;
    text-transform: uppercase;
  }
  
  #save-btn {
    background: #27ae60;
    border: none;
    color: white;
    font-family: 'Press Start 2P', cursive;
    font-size: 0.6rem;
    padding: 5px 10px;
    cursor: pointer;
  }

  .leaderboard-table {
    width: 100%;
    font-size: 0.6rem;
    border-collapse: collapse;
    margin-top: 10px;
    text-align: left;
  }
  
  .leaderboard-table th { color: #888; border-bottom: 1px solid #444; padding: 5px; }
  .leaderboard-table td { padding: 5px; border-bottom: 1px solid #222; }
  .rank-1 { color: #f1c40f; } 
  .rank-2 { color: #bdc3c7; }
  .rank-3 { color: #cd7f32; }

  /* VISUAL FX */
  #flash-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    opacity: 0;
    pointer-events: none;
    z-index: 50;
    transition: opacity 0.15s ease-out;
  }
</style>
</head>
<body>

<div id="game-container">
  <canvas id="gameCanvas"></canvas>
  <div id="flash-overlay"></div>
  
  <div id="ui-layer">
    <div id="score-display" class="hidden">0</div>

    <div id="start-screen">
      <h1>FARTY<br>BIRD<br><span style="font-size: 1rem; color: #fff;">CITY NIGHTS</span></h1>
      <p>Tap, Click, or Space<br>to Fart & Fly!</p>
      
      <div class="character-selector">
        <label>SELECT PILOT:</label>
        <div class="character-grid"></div>
      </div>

      <div class="difficulty-selector">
        <label>DIFFICULTY:</label>
        <div class="difficulty-btns">
          <button class="diff-btn" data-diff="easy">EASY</button>
          <button class="diff-btn selected" data-diff="normal">NORMAL</button>
          <button class="diff-btn" data-diff="hard">HARD</button>
        </div>
      </div>

      <button class="btn" id="start-btn">PLAY</button>
      
      <div class="footer-text">
        Made with ðŸ’¨ ðŸ˜‚<br>Fart Responsibly
      </div>
    </div>

    <div id="game-over-screen" class="hidden">
      <h1>CRASHED!</h1>
      
      <div id="game-over-stats">
        <div>SCORE: <span id="final-score" style="color:#f4b41b">0</span></div>
        <div style="margin-top:5px; font-size:0.8rem">BEST: <span id="best-score" style="color:#58d68d">0</span></div>
      </div>

      <div id="input-container">
        <div id="input-row">
          <input type="text" id="player-name" maxlength="3" placeholder="AAA">
          <button id="save-btn">SAVE</button>
        </div>
      </div>

      <table class="leaderboard-table">
        <thead><tr><th>#</th><th>NAME</th><th>PTS</th></tr></thead>
        <tbody id="leaderboard-body"></tbody>
      </table>

      <button class="btn" id="restart-btn" style="margin-top: 20px;">RETRY</button>
      
      <div class="footer-text">
        Made with ðŸ’¨ ðŸ˜‚<br>Fart Responsibly
      </div>
    </div>
  </div>
</div>

<script>
/**
 * FARTY BIRD: CITY NIGHTS (MASTER EDITION)
 * Refactored for stability, performance, and extra juice.
 */

// --- ENGINE & SETUP ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
const ui = {
  score: document.getElementById('score-display'),
  start: document.getElementById('start-screen'),
  gameOver: document.getElementById('game-over-screen'),
  finalScore: document.getElementById('final-score'),
  bestScore: document.getElementById('best-score'),
  flash: document.getElementById('flash-overlay'),
  charGrid: document.querySelector('.character-grid'),
  leaderboard: document.getElementById('leaderboard-body'),
  nameInput: document.getElementById('player-name'),
  saveBtn: document.getElementById('save-btn'),
  inputContainer: document.getElementById('input-container')
};

// High DPI & Responsive Handling
let scale = 1;
function resize() {
  const container = document.getElementById('game-container');
  const targetRatio = 432 / 768;
  const containerRatio = container.clientWidth / container.clientHeight;
  let finalWidth, finalHeight;
  
  if (containerRatio < targetRatio) {
    finalWidth = container.clientWidth;
    finalHeight = finalWidth / targetRatio;
  } else {
    finalHeight = container.clientHeight;
    finalWidth = finalHeight * targetRatio;
  }
  
  const dpr = window.devicePixelRatio || 1;
  canvas.width = 432 * dpr;
  canvas.height = 768 * dpr;
  canvas.style.width = `${finalWidth}px`;
  canvas.style.height = `${finalHeight}px`;
  ctx.scale(dpr, dpr);
  scale = dpr;
}
window.addEventListener('resize', resize);
resize();

// Game Variables
const state = { current: 0, getReady: 0, game: 1, over: 2 };
let frames = 0;
let score = 0;
let bestScore = parseInt(localStorage.getItem('fartybird_city_best')) || 0;
let selectedChar = 0;
let shakeIntensity = 0;

// Settings
const difficultySettings = {
  easy: { gravity: 0.22, jump: 4.4, gap: 190, speed: 2.5, spawnRate: 130 },
  normal: { gravity: 0.25, jump: 4.6, gap: 160, speed: 3.0, spawnRate: 110 },
  hard: { gravity: 0.30, jump: 5.0, gap: 130, speed: 3.8, spawnRate: 90 }
};
let diff = difficultySettings.normal;

// --- AUDIO ENGINE ---
const audio = {
  ctx: null,
  bgGain: null,
  init: function() {
    if (!this.ctx) {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      this.setupBgMusic();
    }
    if (this.ctx.state === 'suspended') this.ctx.resume();
  },
  setupBgMusic: function() {
    const bufferSize = this.ctx.sampleRate * 2;
    const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
    const data = buffer.getChannelData(0);
    let lastOut = 0;
    for (let i = 0; i < bufferSize; i++) {
      const white = Math.random() * 2 - 1;
      lastOut = (lastOut + (0.02 * white)) / 1.02;
      data[i] = lastOut * 3.5;
    }
    const noise = this.ctx.createBufferSource();
    noise.buffer = buffer;
    noise.loop = true;
    const filter = this.ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 400;
    this.bgGain = this.ctx.createGain();
    this.bgGain.gain.value = 0.15;
    noise.connect(filter); filter.connect(this.bgGain);
    this.bgGain.connect(this.ctx.destination);
    noise.start();
    this.scheduleBeat();
  },
  scheduleBeat: function() {
    const bpm = 90;
    const stepTime = (60/bpm)/4;
    let step = 0;
    const kick = [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,1,0];
    const snr  = [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0];
    const hat  = [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0];
    setInterval(() => {
        if(this.ctx && this.ctx.state === 'running' && state.current !== state.over) {
            const t = this.ctx.currentTime;
            if(kick[step]) this.playTone(t, 150, 40, 'sine', 0.5);
            if(snr[step])  this.playNoise(t, 1000, 0.3);
            if(hat[step])  this.playNoise(t, 7000, 0.08, 0.03);
            step = (step + 1) % 16;
        }
    }, stepTime * 1000);
  },
  playTone: function(t, f1, f2, type, vol) {
    const osc = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(f1, t);
    osc.frequency.exponentialRampToValueAtTime(f2, t + 0.1);
    g.gain.setValueAtTime(vol, t);
    g.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
    osc.connect(g); g.connect(this.bgGain);
    osc.start(t); osc.stop(t+0.15);
  },
  playNoise: function(t, freq, vol, dur=0.1) {
    const bSize = this.ctx.sampleRate * dur;
    const b = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate);
    const d = b.getChannelData(0);
    for(let i=0; i<bSize; i++) d[i] = Math.random() * 2 - 1;
    const src = this.ctx.createBufferSource();
    src.buffer = b;
    const f = this.ctx.createBiquadFilter();
    f.type = 'highpass'; f.frequency.value = freq;
    const g = this.ctx.createGain();
    g.gain.setValueAtTime(vol, t);
    g.gain.exponentialRampToValueAtTime(0.01, t + dur);
    src.connect(f); f.connect(g); g.connect(this.bgGain);
    src.start(t);
  },
  playFart: function() {
    if(!this.ctx) return;
    const t = this.ctx.currentTime;
    const osc = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    const f = this.ctx.createBiquadFilter();
    const rotOsc = this.ctx.createOscillator();
    const rotGain = this.ctx.createGain();
    osc.connect(f); f.connect(g); g.connect(this.ctx.destination);
    rotOsc.connect(rotGain); rotGain.connect(osc.frequency);
    
    let dur = 0.3 + Math.random()*0.4;
    osc.type = 'sawtooth'; rotOsc.type = 'sawtooth';
    rotOsc.frequency.value = 20 + Math.random()*30;
    rotGain.gain.value = 20 + Math.random()*20;
    osc.frequency.setValueAtTime(150+Math.random()*100, t);
    osc.frequency.exponentialRampToValueAtTime(40, t+dur);
    f.frequency.setValueAtTime(800, t);
    f.frequency.exponentialRampToValueAtTime(50, t+dur);
    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(0.5, t+0.05);
    g.gain.exponentialRampToValueAtTime(0.01, t+dur);
    rotOsc.start(t); osc.start(t);
    rotOsc.stop(t+dur); osc.stop(t+dur);
  },
  playCrash: function() {
    if(!this.ctx) return;
    const t = this.ctx.currentTime;
    // Impact Noise
    this.playNoise(t, 100, 0.8, 0.4);
    // Sad descent
    const osc = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(300, t);
    osc.frequency.linearRampToValueAtTime(50, t+0.5);
    g.gain.setValueAtTime(0.3, t);
    g.gain.linearRampToValueAtTime(0, t+0.5);
    osc.connect(g); g.connect(this.ctx.destination);
    osc.start(t); osc.stop(t+0.5);
  }
};

// --- ENTITIES ---

const bg = {
  stars: [],
  init: function() {
    for(let i=0; i<80; i++) this.stars.push({x:Math.random()*432, y:Math.random()*600, s:Math.random()*2+0.5, a:Math.random()});
  },
  draw: function() {
    // Gradient
    const g = ctx.createLinearGradient(0,0,0,768);
    g.addColorStop(0,'#050510'); g.addColorStop(1,'#1a1a2e');
    ctx.fillStyle = g; ctx.fillRect(0,0,432,768);
    // Stars
    ctx.fillStyle = '#fff';
    this.stars.forEach(s => {
      ctx.globalAlpha = 0.5 + Math.sin(frames*0.05 + s.a)*0.5;
      ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
    });
    ctx.globalAlpha = 1;
    // Moon
    ctx.fillStyle = '#f5f5dc'; ctx.shadowBlur=40; ctx.shadowColor='rgba(255,255,200,0.3)';
    ctx.beginPath(); ctx.arc(350,100,40,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
    // Skyline
    ctx.fillStyle = '#111122';
    for(let i=0; i<432; i+=40) ctx.fillRect(i, 768-112-(40+Math.sin(i)*30), 42, 100);
  }
};

const fg = {
  h: 112, x: 0,
  draw: function() {
    if(state.current === state.game) this.x = (this.x - diff.speed) % 40;
    ctx.fillStyle = '#3a3a3a'; ctx.fillRect(0, 768-this.h, 432, this.h);
    ctx.fillStyle = '#222'; ctx.fillRect(0, 768-this.h+15, 432, this.h-15);
    ctx.fillStyle = '#f1c40f';
    for(let i=this.x; i<432; i+=40) ctx.fillRect(i, 768-50, 25, 6);
    ctx.fillStyle = '#555'; ctx.fillRect(0, 768-this.h, 432, 5);
  }
};

const bird = {
  x: 120, y: 350, r: 16, v: 0,
  draw: function() {
    ctx.save();
    ctx.translate(this.x, this.y);
    let rot = Math.min(Math.PI/4, Math.max(-Math.PI/4, (this.v * 0.1)));
    if(state.current === state.getReady) rot = 0;
    ctx.rotate(rot);
    drawCharacter(selectedChar);
    ctx.restore();
  },
  flap: function() {
    this.v = -diff.jump;
    audio.playFart();
    // Spawn particles
    for(let i=0; i<5; i++) {
      particles.push({
        x: this.x-10, y: this.y+10,
        vx: (Math.random()-0.5)*5-2, vy: Math.random()*5,
        life: 1, c: `rgba(139,69,19,`
      });
    }
  },
  update: function() {
    if(state.current === state.getReady) {
      this.y = 350 + Math.cos(frames*0.1)*5;
    } else {
      this.v += diff.gravity;
      this.y += this.v;
      if(this.y+this.r >= 768-fg.h) { this.y=768-fg.h-this.r; gameOver(); }
      if(this.y-this.r <= 0) { this.y=this.r; gameOver(); }
    }
  }
};

const pipes = {
  items: [],
  draw: function() {
    this.items.forEach(p => {
      ctx.fillStyle = p.c;
      ctx.fillRect(p.x, 0, 52, p.top);
      ctx.fillRect(p.x, 768-fg.h-p.btm, 52, p.btm);
      // Windows
      ctx.fillStyle = p.wc;
      for(let y=10; y<p.top-20; y+=30) ctx.fillRect(p.x+10, y, 12, 18);
      for(let y=768-fg.h-p.btm+10; y<768-fg.h-10; y+=30) ctx.fillRect(p.x+10, y, 12, 18);
      // Edge
      ctx.fillStyle = 'rgba(0,0,0,0.3)';
      ctx.fillRect(p.x+48, 0, 4, p.top);
      ctx.fillRect(p.x+48, 768-fg.h-p.btm, 4, p.btm);
    });
  },
  update: function() {
    if(frames % diff.spawnRate === 0) {
      const avail = 768 - fg.h - diff.gap;
      const top = Math.random() * (avail - 100) + 50;
      this.items.push({
        x: 432, top: top, btm: avail - top,
        c: ['#444','#5a3d31','#2f4f4f'][Math.floor(Math.random()*3)],
        wc: Math.random()>0.5 ? '#1a1a1a' : '#f1c40f',
        passed: false
      });
    }
    for(let i=0; i<this.items.length; i++) {
      let p = this.items[i];
      p.x -= diff.speed;
      // Collision
      if(bird.x+bird.r > p.x && bird.x-bird.r < p.x+52) {
        if(bird.y-bird.r < p.top || bird.y+bird.r > 768-fg.h-p.btm) gameOver();
      }
      // Score
      if(p.x+52 < bird.x && !p.passed) {
        score++; p.passed=true; ui.score.innerText=score;
      }
      if(p.x+52 < 0) { this.items.shift(); i--; }
    }
  }
};

let particles = [];
function updateParticles() {
  for(let i=particles.length-1; i>=0; i--) {
    let p = particles[i];
    p.x += p.vx; p.y += p.vy; p.life -= 0.03;
    if(p.life<=0) particles.splice(i,1);
    else {
      ctx.fillStyle = p.c + p.life + ')';
      ctx.beginPath(); ctx.arc(p.x,p.y,5*p.life,0,Math.PI*2); ctx.fill();
    }
  }
}

// --- DRAW HELPERS ---
function drawCharacter(id) {
  const eyes = () => {
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(6,-8,5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(8,-8,2,0,Math.PI*2); ctx.fill();
  };
  const beak = () => { ctx.fillStyle='#e67e22'; ctx.beginPath(); ctx.moveTo(10,-4); ctx.lineTo(20,-2); ctx.lineTo(16,4); ctx.fill(); };
  
  if(id===0) { // Cool Duck
    ctx.fillStyle='#f1c40f'; ctx.beginPath(); ctx.arc(0,0,14,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#333'; ctx.beginPath(); ctx.arc(0,-6,14,Math.PI,0); ctx.fill();
    ctx.fillRect(8,-6,12,4); beak();
    ctx.fillStyle='#000'; ctx.fillRect(2,-8,12,4);
  } else if(id===1) { // Beanie
    ctx.fillStyle='#3498db'; ctx.beginPath(); ctx.arc(0,0,14,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#e74c3c'; ctx.beginPath(); ctx.arc(0,-8,13,Math.PI,0); ctx.fill();
    ctx.beginPath(); ctx.arc(0,-20,4,0,Math.PI*2); ctx.fill();
    eyes(); beak();
  } else if(id===2) { // Sick
    ctx.fillStyle='#2ecc71'; ctx.beginPath(); ctx.arc(0,0,14,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#27ae60'; ctx.beginPath(); ctx.arc(0,-8,14,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(6,-8,5,0,Math.PI*2); ctx.stroke();
    beak();
  } else {
    const cols = ['#9b59b6', '#e67e22', '#1abc9c', '#34495e', '#7dcea0'];
    ctx.fillStyle = cols[id % cols.length];
    ctx.beginPath(); ctx.arc(0,0,14,0,Math.PI*2); ctx.fill();
    eyes(); beak();
  }
  ctx.fillStyle='rgba(0,0,0,0.2)'; ctx.beginPath(); ctx.ellipse(-8,4,8,5,0.5,0,Math.PI*2); ctx.fill();
}

// --- LOGIC ---
function init() {
  // Init Characters
  ui.charGrid.innerHTML = '';
  for(let i=0; i<8; i++) {
    const btn = document.createElement('button');
    btn.className = `char-btn ${i===0?'selected':''}`;
    const cvs = document.createElement('canvas');
    cvs.width=50; cvs.height=50;
    const c = cvs.getContext('2d');
    c.translate(25,25); c.scale(1.2,1.2);
    
    // Draw preview
    const tempCtx = ctx; ctx = c; 
    drawCharacter(i); 
    ctx = tempCtx;

    btn.appendChild(cvs);
    btn.onclick = () => {
      document.querySelectorAll('.char-btn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected'); selectedChar = i; bird.y -= 5;
    };
    ui.charGrid.appendChild(btn);
  }
  
  // Init Difficulty
  document.querySelectorAll('.diff-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      diff = difficultySettings[btn.dataset.diff];
    }
  });

  ui.saveBtn.onclick = saveScore;
  bg.init();
  loop();
}

function startGame() {
  audio.init();
  state.current = state.game;
  ui.start.classList.add('hidden');
  ui.score.classList.remove('hidden');
  bird.flap();
}

function gameOver() {
  if(state.current === state.over) return;
  state.current = state.over;
  audio.playCrash();
  shakeIntensity = 25;
  ui.flash.style.opacity = '0.9';
  setTimeout(() => ui.flash.style.opacity = '0', 100);

  if(score > bestScore) {
    bestScore = score;
    localStorage.setItem('fartybird_city_best', bestScore);
  }
  
  ui.finalScore.innerText = score;
  ui.bestScore.innerText = bestScore;
  ui.inputContainer.style.display = 'block';
  updateLeaderboard();
  
  ui.score.classList.add('hidden');
  ui.gameOver.classList.remove('hidden');
}

function saveScore() {
  const name = ui.nameInput.value.toUpperCase() || 'AAA';
  const lb = JSON.parse(localStorage.getItem('fartybird_leaderboard') || '[]');
  lb.push({name, score});
  lb.sort((a,b)=>b.score-a.score);
  localStorage.setItem('fartybird_leaderboard', JSON.stringify(lb.slice(0,5)));
  ui.inputContainer.style.display = 'none';
  updateLeaderboard();
}

function updateLeaderboard() {
  const lb = JSON.parse(localStorage.getItem('fartybird_leaderboard') || '[]');
  ui.leaderboard.innerHTML = lb.map((e,i) => `
    <tr>
      <td class="rank-${i+1}">${i+1}</td>
      <td>${e.name}</td>
      <td>${e.score}</td>
    </tr>`).join('');
}

function resetGame() {
  bird.y = 350; bird.v = 0;
  pipes.items = [];
  particles = [];
  score = 0; frames = 0;
  ui.score.innerText = '0';
  state.current = state.getReady;
  ui.gameOver.classList.add('hidden');
  ui.start.classList.remove('hidden');
}

function loop() {
  // Update
  bird.update();
  if(state.current === state.game) pipes.update();
  
  // Draw
  ctx.save();
  if(shakeIntensity > 0) {
    ctx.translate((Math.random()-0.5)*shakeIntensity, (Math.random()-0.5)*shakeIntensity);
    shakeIntensity *= 0.9;
    if(shakeIntensity < 0.5) shakeIntensity = 0;
  }
  ctx.clearRect(0,0,432,768);
  
  bg.draw();
  pipes.draw();
  fg.draw();
  updateParticles();
  bird.draw();
  
  ctx.restore();
  frames++;
  requestAnimationFrame(loop);
}

// Inputs
window.onkeydown = (e) => {
  if(e.code==='Space') {
    if(state.current===state.getReady) startGame();
    else if(state.current===state.game) bird.flap();
  }
};
canvas.onmousedown = () => { if(state.current===state.game) bird.flap(); };
canvas.ontouchstart = (e) => { e.preventDefault(); if(state.current===state.game) bird.flap(); };
document.getElementById('start-btn').onclick = startGame;
document.getElementById('restart-btn').onclick = resetGame;

window.onload = init;
</script>
</body>
</html>
